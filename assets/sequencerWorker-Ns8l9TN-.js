(function(){"use strict";function P(o,d){if(o.length===0)return[];const t={sku:0,sublote:1,tamano:o[0]},r=d.map((s,a)=>({producto:a,dias:s})).filter(s=>s.producto!==0).sort((s,a)=>s.dias-a.dias);return[t,...r.map(({producto:s})=>({sku:s,sublote:1,tamano:o[s]}))]}function N(o,d,t){const r=o.length;if(r===0)return[];const s=[];let a=0;s.push({sku:a,sublote:1,tamano:o[a]});const l=new Set([a]);for(;l.size<r;){let i=-1,h=1/0;for(let u=1;u<r;u++){if(l.has(u))continue;const e=d[a],n=d[u],c=e!==void 0&&e!==-1&&n!==void 0&&n!==-1&&t[e]?.[n]!==void 0?t[e][n]:0;c<h?(h=c,i=u):c===h&&Math.random()>.5&&(i=u)}if(i!==-1)a=i,s.push({sku:a,sublote:1,tamano:o[a]}),l.add(a);else break}for(let i=1;i<r;i++)l.has(i)||(s.push({sku:i,sublote:1,tamano:o[i]}),l.add(i));return s}function R(o,d,t,r,s){const a=o.length;if(a===0)return[];let l=0,i=0,h=0;for(let f=1;f<a;f++)l+=t[f];l/=a-1||1;for(let f=0;f<s.length;f++)for(let M=0;M<s[f].length;M++)s[f][M]>0&&(i+=s[f][M],h++);i/=h||1;const u=[];let e=0;u.push({sku:e,sublote:1,tamano:o[e]});const n=new Set([e]);let c=0;const p=1.5,k=.5;for(;n.size<a;){let f=-1,M=-1/0;for(let m=1;m<a;m++){if(n.has(m))continue;const S=t[m],T=d[m],g=r[e],_=r[m],C=g!==void 0&&g!==-1&&_!==void 0&&_!==-1&&s[g]?.[_]!==void 0?s[g][_]/24:0,x=Math.max(T-S-c,0),v=Math.exp(-x/(p*l)),b=Math.exp(-C/(k*i)),E=1/(S||1)*v*b;E>M?(M=E,f=m):E===M&&Math.random()>.5&&(f=m)}if(f!==-1){e=f,u.push({sku:e,sublote:1,tamano:o[e]}),n.add(e);const m=r[u[u.length-2].sku],S=r[e],T=m!==void 0&&m!==-1&&S!==void 0&&S!==-1&&s[m]?.[S]!==void 0?s[m][S]/24:0;c+=t[e]+T}else break}for(let f=1;f<a;f++)n.has(f)||(u.push({sku:f,sublote:1,tamano:o[f]}),n.add(f));return u}function L(o,d,t){const{produccionTn:r,diasStock:s,diasFabricacion:a,idCambios:l,matrizCambioMedida:i}=o,h=[],u=I(P(r,s),o),e=I(N(r,l,i),o),n=I(R(r,s,a,l,i),o);for(h.push(u,e,n);h.length<t;){let c=[];const p=Math.random();d==="min_lost_sales"?c=[...(p>.3?n:u).secuencia]:d==="min_changeovers"?c=[...e.secuencia]:c=[...(p>.6?n:p>.3?e:u).secuencia];const k=Math.floor((c.length-1)*(.2+Math.random()*.3));for(let f=0;f<k;f++){const M=Math.floor(Math.random()*(c.length-1))+1,m=Math.floor(Math.random()*(c.length-1))+1;[c[M],c[m]]=[c[m],c[M]]}h.push(I(c,o))}return h}function O(o,d,t,r,s,a){let l=0,i=0,h=0;const u=[...r],e={};for(const{sku:c,tamano:p}of o)e[c]=(e[c]||0)+p;const n=new Array(o.length).fill(0);for(let c=0;c<o.length;c++){const{sku:p,tamano:k}=o[c];if(c>0){const S=o[c-1].sku,T=a[S],g=a[p];let _=0;T!==void 0&&T!==-1&&g!==void 0&&g!==-1&&(_=d[T]&&d[T][g]!==void 0?d[T][g]:0),n[c]=_,l+=_,i+=_}const f=Math.max(0,i-u[p]);h+=f*t[p];const M=s[p]*(k/(e[p]||1)),m=t[p]>0?k/t[p]:999;u[p]+=m,i+=M}return{tiempoAcumulado:i,tiempoTotalCambio:l,ventaPerdidaTotal:h,tiemposCambio:n}}function I(o,d){const{matrizCambioMedida:t,ventaDiaria:r,diasStock:s,diasFabricacion:a,pesoVenta:l,idCambios:i,costoToneladaPerdida:h,costoHoraCambio:u}=d,e=O(o,t,r,s,a,i),{tiempoTotalCambio:n,ventaPerdidaTotal:c}=e,p=c*h,k=n*u;let f=0;for(let m=1;m<o.length;m++)i[o[m].sku]===i[o[m-1].sku]&&(f+=u*.1);const M=Math.max(0,l*p+(1-l)*k-f);return{secuencia:o,costos:e,costoVP:p,costoTC:k,aptitud:1/(M+1e-4)}}function y(o,d){const t=o.length;if(t<=1)return[...o];const r=Math.floor(Math.random()*(t-1))+1,s=Math.floor(Math.random()*(t-r))+r,a=new Array(t).fill(null),l=new Set;for(let n=r;n<=s;n++)a[n]=o[n],l.add(o[n].sku);let i=0;for(let n=0;n<t;n++)if(!(n>=r&&n<=s)){for(;i<t&&l.has(d[i].sku);)i++;i<t&&(a[n]=d[i],l.add(d[i].sku),i++)}const u=[...new Set(o.map(n=>n.sku))].filter(n=>!l.has(n));let e=0;for(let n=0;n<t;n++)a[n]===null&&e<u.length&&(a[n]=o.find(c=>c.sku===u[e])||d.find(c=>c.sku===u[e]),e++);return a}function w(o,d){if(Math.random()>d)return o;const t=o.length;if(t<=2)return o;if(Math.random()<.5){const s=Math.floor(Math.random()*(t-1))+1;let a=Math.floor(Math.random()*(t-1))+1;for(;s===a;)a=Math.floor(Math.random()*(t-1))+1;[o[s],o[a]]=[o[a],o[s]]}else{const s=Math.floor(Math.random()*(t-1))+1;let a=Math.floor(Math.random()*(t-1))+1;const[l]=o.splice(s,1);o.splice(a,0,l)}return o}function A(o,d){const t=o.secuencia.length;if(t<=3)return o;let r=o,s=!0,a=50;for(;s&&a>0;){s=!1,a--;for(let l=1;l<t-1;l++){for(let i=l+1;i<t;i++){if(i-l<=1&&i<t-1)continue;const h=[...r.secuencia],u=h.slice(l,i+1).reverse();h.splice(l,u.length,...u);const e=I(h,d);if(e.aptitud>r.aptitud){r=e,s=!0;break}}if(s)break}}return r}function H(o,d){const t=o.secuencia.length;if(t<=3)return o;let r=o;const s=Math.min(30,t*2);for(let a=0;a<s;a++){const l=Math.floor(Math.random()*(t-2))+1,i=Math.floor(Math.random()*(t-1-l))+l+1;if(i-l<=1)continue;const h=[...r.secuencia],u=h.slice(l,i+1).reverse();h.splice(l,u.length,...u);const e=I(h,d);e.aptitud>r.aptitud&&(r=e)}return r}function j(o){let d=o[Math.floor(Math.random()*o.length)];for(let t=1;t<5;t++){const r=o[Math.floor(Math.random()*o.length)];r.aptitud>d.aptitud&&(d=r)}return d}onmessage=function(o){const{type:d,params:t}=o.data;if(d==="run"){const r=performance.now(),{tamanoPoblacion:s,tasaMutacion:a,tasaElitismo:l}=t,i=28e3;let h=0;const u=t.pesoVenta>.8?"min_lost_sales":t.pesoVenta<.2?"min_changeovers":"balanced";let e=L(t,u,s);e[0]=A(e[0],t),e[1]=A(e[1],t),e[2]=A(e[2],t);let n=e[0];for(const g of e)g.aptitud>n.aptitud&&(n=g);let c=0,p=0;for(;performance.now()-r<i;){p++,e.sort((v,b)=>b.aptitud-v.aptitud),e[0].aptitud>n.aptitud?(n=e[0],c=0):c++;let g=c>20?Math.min(.8,a*2.5):a;if(c>30){for(let v=s-1;v>s*.5;v--){let b=w([...n.secuencia],1);b=w(b,1),e[v]=I(b,t)}e[0]=A(e[0],t),e[0].aptitud>n.aptitud&&(n=e[0]),c=0}const _=Math.max(1,Math.floor((l||.1)*s)),C=e.slice(0,_);if(p%10===0){const v=Math.floor(C.length*.2)||1;for(let b=0;b<v;b++)C[b]=H(C[b],t)}for(;C.length<s;){const v=j(e),b=j(e);let E=y(v.secuencia,b.secuencia);E=w(E,g),C.push(I(E,t))}e=C;const x=performance.now()-r;if(x-h>500){const v=Math.min(99,Math.round(x/i*100));self.postMessage({type:"progress",progress:v,currentBest:n.costos.tiempoTotalCambio}),h=x}}n=A(n,t);const{tiempoTotalCambio:k,ventaPerdidaTotal:f,tiempoAcumulado:M,tiemposCambio:m}=n.costos,S=f*t.costoToneladaPerdida,T=k*t.costoHoraCambio;self.postMessage({type:"complete",result:{secuencia:n.secuencia,tiempoTotalCambio:k,ventaPerdidaTotal:f,tiempoProduccionTotal:M-k,costoVentaPerdida:S,costoTiempoCambio:T,costoTotal:S+T,tiemposCambio:m,processingTime:(performance.now()-r)/1e3,params_skus:t.skus,params_desc:t.descripciones,params_cant:t.produccionTn,params_idCambios:t.idCambios,params_ids:t.ids}})}}})();
